<!-- Header with Navigation and Mini Progress Counter -->
<header class="bg-primary text-white shadow-md sticky top-0 z-50">
  <div class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between">
      <!-- App Title -->
      <h1 class="text-2xl font-bold">NotesAllSanity</h1>

      <!-- Navigation -->
      <nav class="flex gap-2">
        <p-button
          label="Checks"
          [outlined]="true"
          severity="secondary"
          routerLink="/checks"
          routerLinkActive="!bg-white !text-primary"
        />
        <p-button
          label="Entrances"
          [outlined]="true"
          severity="secondary"
          routerLink="/entrances"
          routerLinkActive="!bg-white !text-primary"
        />
        <p-button
          label="Pathfinding"
          [outlined]="true"
          severity="secondary"
          routerLink="/pathfinding"
          routerLinkActive="!bg-white !text-primary"
        />
        <p-button
          label="Stats"
          [outlined]="true"
          severity="secondary"
          routerLink="/stats"
          routerLinkActive="!bg-white !text-primary"
        />
      </nav>

      <!-- Mini Progress Counter and Actions -->
      <div class="flex items-center gap-4">
        <!-- Mini Progress Counter (FR34: Always visible) -->
        <div class="mini-progress flex items-center gap-2">
          <span class="text-sm font-medium">Progress:</span>
          <p-badge
            [value]="progressText()"
            severity="success"
            styleClass="text-base px-3 py-1"
          />
        </div>

        <!-- Save/Load Actions -->
        <p-button
          label="Export Save"
          icon="pi pi-download"
          severity="secondary"
          [outlined]="true"
          (onClick)="exportSave()"
        />
        <p-button
          label="Import Save"
          icon="pi pi-upload"
          severity="secondary"
          [outlined]="true"
          (onClick)="importSave()"
        />

        <!-- Import Spoiler Button -->
        <p-button
          label="Import Spoiler"
          icon="pi pi-file"
          severity="secondary"
          [outlined]="true"
          (onClick)="openImportDialog()"
        />
      </div>
    </div>
  </div>
</header>

<!-- Success Message Toast (FR37: Export success feedback) -->
@if (showSuccessMessage()) {
  <div class="fixed top-20 right-4 z-50 animate-fade-in">
    <p-message severity="success" [text]="successMessage()" />
  </div>
}

<!-- Main Content -->
<main class="min-h-screen bg-gray-50">
  <router-outlet />
</main>

<!-- Import Dialog -->
<app-import-dialog #importDialog />

<!-- Load Save Confirmation/Error Dialog -->
<p-dialog
  [(visible)]="showLoadDialog"
  [modal]="true"
  [style]="{ width: '500px' }"
  [header]="loadErrors().length > 0 ? 'Import Failed' : 'Confirm Import'"
>
  @if (loadingSave()) {
    <div class="flex flex-col items-center gap-4 p-4">
      <i class="pi pi-spin pi-spinner text-4xl"></i>
      <p>Validating save file...</p>
    </div>
  } @else if (loadErrors().length > 0) {
    <!-- FR41: Validation errors display -->
    <div class="flex flex-col gap-4">
      <p-message severity="error" text="Save file validation failed:" />
      
      @for (error of loadErrors(); track error) {
        <p-message severity="error" [text]="error" />
      }
      
      <p class="text-sm text-gray-600 mt-2">
        Your current state has NOT been modified - your progress is safe.
      </p>
    </div>
  } @else if (loadMetadata()) {
    <!-- FR43: Save metadata confirmation -->
    <div class="flex flex-col gap-4">
      <p>Load this save file?</p>
      
      <div class="flex flex-col gap-2 bg-gray-50 p-4 rounded">
        <div><strong>Save Date:</strong> {{ loadMetadata()!.save_date }}</div>
        <div><strong>Total Checks:</strong> {{ loadMetadata()!.total_checks }}</div>
        <div><strong>Completed:</strong> {{ loadMetadata()!.completed_checks }}</div>
      </div>

      <!-- NFR-UX-5, NFR-REL-3: Clear warning with p-message -->
      <p-message
        severity="warn"
        text="Warning: This will replace your current progress."
      />
    </div>
  }

  <ng-template pTemplate="footer">
    @if (loadErrors().length > 0) {
      <p-button
        label="Close"
        severity="secondary"
        (onClick)="cancelImport()"
      />
    } @else if (loadMetadata()) {
      <p-button
        label="Cancel"
        severity="secondary"
        [outlined]="true"
        (onClick)="cancelImport()"
      />
      <p-button
        label="Load Save"
        severity="primary"
        (onClick)="confirmImport()"
      />
    }
  </ng-template>
</p-dialog>
