<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OoT Randomizer Tracker – sans dépendances React</title>
    <style>
      :root { --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --card:#ffffff; --border:#e2e8f0; --accent:#111827; --green:#16a34a; --amber:#f59e0b; --red:#ef4444; }
      html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
      .container{max-width:1100px;margin:0 auto;padding:16px}
      .title{font-weight:800;font-size:24px}
      .subtitle{color:var(--muted);font-size:13px;margin:6px 0 0}
      .row{display:flex;flex-wrap:wrap;gap:16px;margin-top:16px}
      .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
      .grow{flex:1 1 380px}
      input[type=text]{border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px;width:100%}
      .btn{border:0;border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer}
      .btn-dark{background:var(--accent);color:#fff}
      .btn-green{background:var(--green);color:#fff}
      .btn-amber{background:var(--amber);color:#fff}
      .btn-plain{background:#e5e7eb}
      .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
      .filters{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
      .muted{color:var(--muted)}
      .scene{background:#fff;border:1px solid var(--border);border-radius:14px;overflow:hidden}
      .scene-h{display:flex;gap:10px;align-items:center;padding:10px 12px}
      .scene-h button.tgl{width:28px;height:28px;border-radius:8px;background:#f1f5f9;border:1px solid var(--border);cursor:pointer}
      .scene-body{border-top:1px solid var(--border)}
      .item{display:flex;gap:10px;align-items:center;padding:8px 12px}
      .item:hover{background:#f8fafc}
      .item .loc{font-size:14px}
      .item .loc.done{text-decoration:line-through;color:#94a3b8}
      .item input.note{margin-left:auto;width:260px;max-width:50vw;border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:12px}
      .notice{margin-top:10px;padding:10px;border-radius:10px;background:#eff6ff;border:1px solid #bfdbfe;font-size:13px}
      .error{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
      .footer{margin:24px 0 8px;font-size:12px;color:var(--muted)}
      .right{margin-left:auto}
      .chip{font-size:12px;color:#334155}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <div id="stickyBar" style="position:fixed;top:0;left:0;right:0;z-index:9999;background:#f8fafcCC;backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #e2e8f0;">
      <div style="max-width:1100px;margin:0 auto;padding:8px 16px;font:13px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;display:flex;gap:8px;align-items:center;">
        <strong>Total :</strong>
        <span id="stickyDone">0</span>
        <span>/</span>
        <span id="stickyTotal">0</span>
        <span class="muted" style="margin-left:4px;">(<span id="stickyRemain">0</span> restants)</span>
      </div>
    </div>
    <div class="container" style="padding-top:56px">
      <div class="title">OoT Randomizer Tracker</div>
      <div class="subtitle">Version autonome, sans React/Babel. Sauvegarde locale + Export/Import JSON.</div>

      <div id="alerts"></div>

      <div class="row">
        <div class="card grow" style="flex:1 1 100%;">
          <div class="muted" style="font-weight:600;margin-bottom:6px">Source OOT</div>
          <input id="ootUrl" type="text" value="https://github.com/OoTMM/OoTMM/blob/master/packages/data/src/pool/pool_oot.csv" />
          <div class="muted" style="margin-top:6px;font-size:12px">ou importer un fichier : <input id="ootFile" type="file" accept=".csv"></div>
        </div>
        </div>

      <div class="toolbar">
        <button id="btnLoad" class="btn btn-dark">Charger depuis l'URL</button>
        <button id="btnAllCheck" class="btn btn-green">Tout cocher (visible)</button>
        <button id="btnAllUncheck" class="btn btn-amber">Tout décocher (visible)</button>
        <button id="btnExport" class="btn btn-plain">Exporter JSON</button>
        <button id="btnImport" class="btn btn-plain">Importer JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </div>

      <div class="card" style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <div class="filters">
          <div class="right chip">Total : <span id="countDone">0</span> / <span id="countTotal">0</span> <span class="muted">(<span id="countRemain">0</span> restants)</span></div>
        </div>
        <input id="search" type="text" placeholder="Recherche scène / location…">
      </div>

      <div id="mapping" class="notice" style="display:none"></div>

      <div id="scenes" style="margin-top:12px;display:grid;gap:10px"></div>

      <div class="footer">Astuce : exportez vos données en JSON pour les sauvegarder; la progression est aussi enregistrée dans <code>localStorage</code>.</div>
    </div>

    <script>
      // ---------- Etat & constantes ----------
      const LS_KEY = 'oot-tracker-state-v3'; // Clé mise à jour
      const GAME = 'OOT'; // Jeu hardcodé à 'OOT'
      let checked = {}; // id -> bool
      let notes = {};   // id -> string

      try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object') {
            if (parsed.checked && typeof parsed.checked === 'object') checked = parsed.checked;
            if (parsed.notes && typeof parsed.notes === 'object') notes = parsed.notes;
          } else if (typeof parsed === 'object') {
            // rétro-compat ancien format
            checked = parsed;
          }
        }
      } catch (e) {}

      function persist() {
        localStorage.setItem(LS_KEY, JSON.stringify({ checked, notes }));
      }

      function showAlert(html, isError=false) {
        const box = document.getElementById('alerts');
        const d = document.createElement('div');
        d.className = 'notice' + (isError ? ' error' : '');
        d.innerHTML = html;
        box.innerHTML = '';
        box.appendChild(d);
        setTimeout(()=>{ if (box.contains(d)) box.removeChild(d); }, 7000);
      }

      function toRawGithubUrl(url) {
        try {
          const u = new URL(url);
          if (u.hostname === 'github.com') {
            const parts = u.pathname.split('/').filter(Boolean);
            const owner = parts[0];
            const repo = parts[1];
            const blobIdx = parts.indexOf('blob');
            if (blobIdx !== -1) {
              const branch = parts[blobIdx + 1];
              const rest = parts.slice(blobIdx + 2).join('/');
              return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${rest}`;
            }
          }
        } catch(e) {}
        return url;
      }

      function inferColumn(headers, candidates) {
        const lower = headers.map(h=>h.toLowerCase());
        for (const c of candidates) {
          const idx = lower.indexOf(c.toLowerCase());
          if (idx !== -1) return headers[idx];
        }
        for (const c of candidates) {
          const hit = headers.find(h => h.toLowerCase().includes(c.toLowerCase()));
          if (hit) return hit;
        }
        return null;
      }

      function slugify(s) {
        return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
      }

      // 'game' est retiré ou hardcodé à GAME
      function makeId(scene, loc) { return `${GAME}:${slugify(scene)}:${slugify(loc)}`; }

      // ---------- Chargement CSV ----------
      let parsedSet = null; // { game, rows, sceneCol, locationCol }

      async function fetchCsv(url) {
        const rawUrl = toRawGithubUrl(url.trim());
        const res = await fetch(rawUrl);
        if (!res.ok) throw new Error(`Impossible de charger ${rawUrl} : ${res.status} ${res.statusText}`);
        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        const headers = parsed.meta.fields || [];
        const sceneCol = inferColumn(headers, ['scene','region','area','map','dungeon','zone']);
        const locationCol = inferColumn(headers, ['location','name','spot','place','check']);
        return { game: GAME, rows: parsed.data || [], sceneCol, locationCol };
      }

      function parseCsvFile(file) {
        return new Promise((resolve, reject) => {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (res) => {
              const headers = res.meta.fields || [];
              const sceneCol = inferColumn(headers, ['scene','region','area','map','dungeon','zone']);
              const locationCol = inferColumn(headers, ['location','name','spot','place','check']);
              resolve({ game: GAME, rows: res.data || [], sceneCol, locationCol });
            },
            error: (err) => reject(err)
          });
        });
      }

      async function loadFromUrls() {
        try {
          const ootUrl = document.getElementById('ootUrl').value;
          parsedSet = await fetchCsv(ootUrl);
          render();
          showAlert('CSV OOT chargé depuis l\'URL.');
        } catch (e) {
          showAlert('Erreur : ' + (e.message || String(e)), true);
        }
      }

      // fichiers locaux (OOT seulement)
      document.getElementById('ootFile').addEventListener('change', async (e)=>{
        const f = e.target.files && e.target.files[0]; if (!f) return;
        try { 
          parsedSet = await parseCsvFile(f); 
          render(); 
          showAlert('CSV OOT importé.'); 
        }
        catch(err){ showAlert('Erreur import OOT: '+(err?.message||err), true); }
      });
      // Retrait de la gestion du fichier MM

      // ---------- Construction des items ----------
      function buildItems() {
        const out = [];
        if (!parsedSet) return out;
        const { game, rows, sceneCol, locationCol } = parsedSet;
        if (!rows?.length || !sceneCol || !locationCol) return out;
        for (const r of rows) {
          const scene = String(r[sceneCol] ?? '').trim();
          const loc = String(r[locationCol] ?? '').trim();
          if (!scene || !loc) continue;
          out.push({ id: makeId(scene, loc), game: GAME, scene, location: loc });
        }
        return out;
      }

      function groupScenes(items) {
        const map = new Map();
        for (const it of items) {
          // 'game' n'est plus utilisé dans la clé de groupement
          const key = `${it.scene}`;
          if (!map.has(key)) map.set(key, { key, game: it.game, scene: it.scene, items: [] });
          map.get(key).items.push(it);
        }
        // Le tri par jeu n'est plus nécessaire
        return Array.from(map.values()).sort((a,b)=>a.scene.localeCompare(b.scene));
      }

      // ---------- Rendu ----------
      const openScenes = {}; // key -> bool

      function render() {
        const scenesEl = document.getElementById('scenes');
        scenesEl.innerHTML = '';

        const items = buildItems();
        const total = items.length;
        const done = items.filter(i => checked[i.id]).length;
        document.getElementById('countTotal').textContent = String(total);
        document.getElementById('countDone').textContent = String(done);
        document.getElementById('countRemain').textContent = String(total - done);
        (function(){try{
          document.getElementById('stickyTotal').textContent = String(total);
          document.getElementById('stickyDone').textContent = String(done);
          document.getElementById('stickyRemain').textContent = String(total - done);
        }catch(e){}})();
        const q = document.getElementById('search').value.trim().toLowerCase();
        
        // Retrait du filtrage par jeu
        const scenes = groupScenes(items)
          .map(s => ({...s, items: s.items.filter(it => !q || it.location.toLowerCase().includes(q) || it.scene.toLowerCase().includes(q))}))
          .filter(s => s.items.length);

        if (!scenes.length) {
          const empty = document.createElement('div');
          empty.className = 'notice';
          empty.textContent = 'Aucune donnée chargée ou aucun résultat pour ce filtre.';
          scenesEl.appendChild(empty);
          return;
        }

        for (const s of scenes) {
          const wrap = document.createElement('div');
          wrap.className = 'scene';

          const head = document.createElement('div');
          head.className = 'scene-h';

          const btn = document.createElement('button');
          btn.className = 'tgl';
          const opened = openScenes[s.key] ?? true;
          btn.textContent = opened ? '−' : '+';
          btn.onclick = () => { openScenes[s.key] = ! (openScenes[s.key] ?? true); render(); };

          const info = document.createElement('div');
          const remain = s.items.filter(i => !checked[i.id]).length;
          // Retrait de la mention du jeu dans le titre de la zone: [${s.game}]
          info.innerHTML = `<div style="font-weight:600">${escapeHtml(s.scene)}</div>
                            <div class="muted" style="font-size:12px">${s.items.length - remain} cochés • ${remain} restants</div>`;

          const bulk = document.createElement('div');
          bulk.className = 'right';
          const b1 = document.createElement('button'); b1.className='btn btn-green'; b1.textContent='Tout cocher';
          b1.onclick = ()=>{ for (const it of s.items) checked[it.id] = true; persist(); render(); };
          const b2 = document.createElement('button'); b2.className='btn btn-amber'; b2.style.marginLeft='6px'; b2.textContent='Tout décocher';
          b2.onclick = ()=>{ for (const it of s.items) checked[it.id] = false; persist(); render(); };
          bulk.appendChild(b1); bulk.appendChild(b2);

          head.appendChild(btn); head.appendChild(info); head.appendChild(bulk);
          wrap.appendChild(head);

          if (opened) {
            const body = document.createElement('div');
            body.className = 'scene-body';
            for (const it of s.items) {
              const row = document.createElement('div'); row.className = 'item';
              const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!checked[it.id];
              cb.onchange = ()=>{ checked[it.id] = cb.checked; persist(); renderCountsOnly(); row.querySelector('.loc').className = 'loc '+(cb.checked?'done':''); };
              const lbl = document.createElement('span'); lbl.className = 'loc ' + (cb.checked?'done':''); lbl.textContent = it.location;
              const nt = document.createElement('input'); nt.type='text'; nt.className='note'; nt.placeholder='Note… (ce que tu as trouvé)'; nt.value = notes[it.id] || '';
              nt.oninput = ()=>{ notes[it.id] = nt.value; persist(); };
              row.appendChild(cb); row.appendChild(lbl); row.appendChild(nt);
              body.appendChild(row);
            }
            wrap.appendChild(body);
          }

          scenesEl.appendChild(wrap);
        }
      }

      function renderCountsOnly(){
        const items = buildItems();
        const total = items.length;
        const done = items.filter(i => checked[i.id]).length;
        document.getElementById('countTotal').textContent = String(total);
        document.getElementById('countDone').textContent = String(done);
        document.getElementById('countRemain').textContent = String(total - done);
        (function(){try{
          document.getElementById('stickyTotal').textContent = String(total);
          document.getElementById('stickyDone').textContent = String(done);
          document.getElementById('stickyRemain').textContent = String(total - done);
        }catch(e){}})();
        }

      function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }

      // ---------- Actions barre d’outils ----------
      document.getElementById('btnLoad').addEventListener('click', loadFromUrls);
      document.getElementById('btnAllCheck').addEventListener('click', ()=>{
        const items = buildItems(); for (const it of items) checked[it.id] = true; persist(); render();
      });
      document.getElementById('btnAllUncheck').addEventListener('click', ()=>{
        const items = buildItems(); for (const it of items) checked[it.id] = false; persist(); render();
      });
      document.getElementById('btnExport').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify({ checked, notes }, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = `oot-tracker-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
      document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('importFile').click());
      document.getElementById('importFile').addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0]; if (!f) return; const r = new FileReader();
        r.onload = ()=>{
          try{ const data = JSON.parse(String(r.result||'{}'));
            if (data && typeof data === 'object'){
              if (data.checked && typeof data.checked === 'object') checked = data.checked; else if (Object.values(data).every(v=>typeof v==='boolean')) checked = data;
              if (data.notes && typeof data.notes === 'object') notes = data.notes; persist(); render();
            } else showAlert('Fichier JSON invalide', true);
          }catch{ showAlert('Impossible de lire ce JSON', true); }
        };
        r.readAsText(f);
      });

      // Filtres
      document.getElementById('search').addEventListener('input', render);
      // Retrait des écouteurs pour fltOOT, fltMM, fltUnknown

      // Premier rendu (vide, avant chargement CSV)
      render();

      // Affichage des erreurs JS dans la page
      window.addEventListener('error', (e)=> showAlert('Erreur JS : '+(e?.error?.message||e.message||String(e)), true));
    </script>
  </body>
</html>